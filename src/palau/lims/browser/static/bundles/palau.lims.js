(()=>{"use strict";var e={311:e=>{e.exports=jQuery}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}(()=>{var e=n(311);function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function r(e,n){for(var r=0;r<n.length;r++){var i=n[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,(void 0,o=function(e,n){if("object"!==t(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,"string");if("object"!==t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(i.key),"symbol"===t(o)?o:String(o)),i)}var o}var i=[].indexOf;const o=function(){function t(){var n,r,o,a;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.is_required=this.is_required.bind(this),this.bind_event_handler=this.bind_event_handler.bind(this),this.on_template_selected=this.on_template_selected.bind(this),this.on_bottle_weight_change=this.on_bottle_weight_change.bind(this),this.on_bottle_container_blur=this.on_bottle_container_blur.bind(this),this.on_sample_type_selected=this.on_sample_type_selected.bind(this),this.get_sample_index=this.get_sample_index.bind(this),this.update_container=this.update_container.bind(this),this.toggle_container_visibility=this.toggle_container_visibility.bind(this),this.set_volume_readonly=this.set_volume_readonly.bind(this),this.calculate_volume=this.calculate_volume.bind(this),this.get_float_value=this.get_float_value.bind(this),this.round=this.round.bind(this),this.set_visible=this.set_visible.bind(this),this.fetch=this.fetch.bind(this),this.ajax_submit=this.ajax_submit.bind(this),this.get_portal_url=this.get_portal_url.bind(this),this.debug=this.debug.bind(this),this.get_add_controller=this.get_add_controller.bind(this),this.is_required()){if(this.debug("load"),this.sample_type_selector="div.uidreferencefield textarea[name^='SampleType']",this.template_selector="input[id^='Template']",this.bottle_weights_selector="input[id^='Bottles-'][id*='-Weight-']",this.bottle_containers_selector="input[id^='Bottles-'][id*='-Container-']",this.bind_event_handler(),i.call(document.body.classList,"template-ar_add")>=0)for(r=0,o=(a=document.querySelectorAll(this.sample_type_selector)).length;r<o;r++)n=a[r],e(n).trigger("select");else document.querySelector("div[data-fieldname='Bottles']")&&(n=document.querySelector("input[id='Volume']")).setAttribute("readonly","readonly");return this}}var n,o;return n=t,o=[{key:"is_required",value:function(){var e,t,n,r,i,o;for(o=["template-ar_add","portaltype-analysisrequest"],t=n=0,r=(i=document.body.classList).length;n<r;t=++n)if(e=i[t],o.includes(e))return!0;return!1}},{key:"bind_event_handler",value:function(){return this.debug("bind_event_handler"),e("body").on("SampleType:after_change",this.sample_type_selector,this.on_sample_type_selected),e("body").on("selected",this.template_selector,this.on_template_selected),e("body").on("blur",this.bottle_containers_selector,this.on_bottle_container_blur),e("body").on("change",this.bottle_weights_selector,this.on_bottle_weight_change)}},{key:"on_template_selected",value:function(t){var n,r,i;if(this.debug("on_template_selected"),n=t.currentTarget,r=this.get_sample_index(n),i=e("#".concat(n.id)).attr("uid"))return this.fetch(i,[]).done((function(e){var t;if(e)return t=e.SampleType_uid,this.update_container(r,t)}))}},{key:"on_bottle_weight_change",value:function(e){var t,n;return this.debug("on_bottle_weight_change"),t=e.currentTarget,n=this.get_sample_index(t),this.calculate_volume(n)}},{key:"on_bottle_container_blur",value:function(e){var t,n;return this.debug("on_bottle_container_blur"),t=e.currentTarget,n=this.get_sample_index(t),this.calculate_volume(n)}},{key:"on_sample_type_selected",value:function(e){var t,n;return this.debug("on_sample_type_selected"),t=e.currentTarget,n=this.get_sample_index(t),this.update_container(n,t.value)}},{key:"get_sample_index",value:function(t){var n;return this.debug("get_sample_index:element=".concat(t.id)),(n=t.closest("td[arnum]"))?e(n).attr("arnum"):null}},{key:"update_container",value:function(e,t){var n;return this.debug("update_container:sample_index=".concat(e,",sample_type_uid=").concat(t)),t?(n="ContainerWidget",this.fetch(t,n).done((function(t){var r;if(r=!1,t&&(r="container"===t[n]),this.toggle_container_visibility(e,r),this.set_volume_readonly(e,!r),!r)return this.calculate_volume(e)}))):(this.toggle_container_visibility(e,!0),this.set_volume_readonly(e,!1))}},{key:"toggle_container_visibility",value:function(e,t){return this.debug("toggle_container_visibility:sample_index=".concat(e,",show_container=").concat(t)),this.set_visible("Container",e,t),this.set_visible("Bottles",e,!t)}},{key:"set_volume_readonly",value:function(e,t){var n,r;if(this.debug("set_volume_readonly:sample_index=".concat(e,",readonly=").concat(t)),r="#Volume",e&&(r="#Volume-".concat(e)),n=document.querySelector(r))return t?n.setAttribute("readonly","readonly"):n.removeAttribute("readonly")}},{key:"calculate_volume",value:function(t){var n,r,i,o,a,l;if(this.debug("calculate_volume:sample_index=".concat(t)),o=0,r="tr.records_row_Bottles",t&&(r="tr.records_row_Bottles-".concat(t)),n=document.querySelectorAll(r),i=this,e.each(n,(function(e,n){var r,a,l,s,c,u;return u="#Bottles-Weight-".concat(e),t&&(u="#Bottles-".concat(t,"-Weight-").concat(e)),c=n.querySelector(u),c=i.get_float_value(c),i.debug("Not a valid volume: ".concat(c)),a="#Bottles-DryWeight-".concat(e),t&&(a="#Bottles-".concat(t,"-DryWeight-").concat(e)),r=n.querySelector(a),r=i.get_float_value(r),i.debug("Not a valid volume: ".concat(r)),(l=c-r)<=0?(i.debug("Not a valid bottle volume: ".concat(l)),l=""):(l=i.round(1.05*l,3),o+=l),s="#Bottles-Volume-".concat(e),t&&(s="#Bottles-".concat(t,"-Volume-").concat(e)),n.querySelector(s).value=l})),o=parseFloat(o),(o=this.round(o,4))<=0?(this.debug("Not a valid volume: ".concat(o)),o=""):o+=" ml",l="#Volume",t&&(l="#Volume-".concat(t)),a=document.querySelector(l))return a.value=o}},{key:"get_float_value",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t=parseFloat(e.value),isNaN(t)&&(t=parseFloat(n)),t}},{key:"round",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"set_visible",value:function(t,n,r){var i,o;return this.debug("set_visible:field_name=".concat(t,",sample_index=").concat(n,",visible=").concat(r)),o="div[data-fieldname='".concat(t,"']"),n&&(o="div[data-fieldname='".concat(t,"-").concat(n,"']")),"0"===n&&"1"===document.querySelector("#ar_count").value&&(o="tr[fieldname=".concat(t,"]")),i=document.querySelector(o),r?e(i).show():e(i).hide()}},{key:"fetch",value:function(t,n){var r,i;return this.debug("fetch:uid=".concat(t,",field_names=").concat(n)),r=e.Deferred(),i={url:this.get_portal_url()+"/@@API/read",data:{catalog_name:"senaite_catalog_setup",UID:t,include_fields:n,page_size:1}},this.ajax_submit(i).done((function(e){var t;return t={},e.objects&&(t=e.objects[0]),r.resolveWith(this,[t])})),r.promise()}},{key:"ajax_submit",value:function(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.debug("ajax_submit"),null==n.type&&(n.type="POST"),null==n.url&&(n.url=this.get_portal_url()),null==n.context&&(n.context=this),null==n.dataType&&(n.dataType="json"),null==n.data&&(n.data={}),null==n._authenticator&&(n._authenticator=e("input[name='_authenticator']").val()),this.debug(">>> ajax_submit::options=",n),e(this).trigger("ajax:submit:start"),t=function(){return e(this).trigger("ajax:submit:end")},e.ajax(n).done(t)}},{key:"get_portal_url",value:function(){return e("input[name=portal_url]").val()||window.portal_url}},{key:"debug",value:function(e){}},{key:"get_add_controller",value:function(){return window.bika.lims.AnalysisRequestAdd}}],o&&r(n.prototype,o),Object.defineProperty(n,"prototype",{writable:!1}),t}();n(311);var a=n(311);function l(e){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l(e)}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(void 0,i=function(e,t){if("object"!==l(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!==l(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key),"symbol"===l(i)?i:String(i)),r)}var i}const c=function(){function e(){var t,n,r,i;for(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.is_required=this.is_required.bind(this),this.bind_event_handler=this.bind_event_handler.bind(this),this.on_reference_other_selector_change=this.on_reference_other_selector_change.bind(this),this.on_reference_selected=this.on_reference_selected.bind(this),this.on_reference_deselected=this.on_reference_deselected.bind(this),this.reference_other_selector="input.reference-otherfield-check",this.reference_value_selector="div.palau-referenceother-widget-input",this.bind_event_handler(),n=0,r=(i=document.querySelectorAll(this.reference_other_selector)).length;n<r;n++)t=i[n],a(t).trigger("change");return this}var t,n;return t=e,(n=[{key:"is_required",value:function(){var e,t,n,r,i,o;for(o=["template-ar_add","portaltype-analysisrequest"],t=n=0,r=(i=document.body.classList).length;n<r;t=++n)if(e=i[t],o.includes(e))return!0;return!1}},{key:"bind_event_handler",value:function(){return a("body").on("change",this.reference_other_selector,this.on_reference_other_selector_change),a("body").on("select",this.reference_value_selector,this.on_reference_selected),a("body").on("deselect",this.reference_value_selector,this.on_reference_deselected)}},{key:"on_reference_other_selector_change",value:function(e){var t,n,r;return t=e.currentTarget,r=a(t).attr("data_target"),n=document.querySelector("#"+r),t.checked?a(n).show():(a(n).hide(),a(n).val(""))}},{key:"on_reference_selected",value:function(e){var t,n,r;return t=e.currentTarget,r="textarea#"+a(t).attr("id")+"_other",n=document.querySelector(r),a(n).hide(),a(n).val("")}},{key:"on_reference_deselected",value:function(e){var t,n,r;return t=e.currentTarget,r="textarea#"+a(t).attr("id")+"_other",n=document.querySelector(r),a(n).show()}}])&&s(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();document.addEventListener("DOMContentLoaded",(function(){window.sampletype_container=new o,window.reference_other=new c}))})()})();