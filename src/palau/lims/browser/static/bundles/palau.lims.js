(()=>{"use strict";var e={311:e=>{e.exports=jQuery}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}(()=>{var e=i(311);function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function n(e,i){for(var n=0;n<i.length;n++){var r=i[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,(void 0,o=function(e,i){if("object"!==t(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!==t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(r.key),"symbol"===t(o)?o:String(o)),r)}var o}var r=[].indexOf;const o=function(){function t(){var i,n,o,l;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.is_required=this.is_required.bind(this),this.bind_event_handler=this.bind_event_handler.bind(this),this.on_template_selected=this.on_template_selected.bind(this),this.on_bottle_weight_change=this.on_bottle_weight_change.bind(this),this.on_bottle_container_blur=this.on_bottle_container_blur.bind(this),this.on_sample_type_selected=this.on_sample_type_selected.bind(this),this.get_sample_index=this.get_sample_index.bind(this),this.update_container=this.update_container.bind(this),this.toggle_container_visibility=this.toggle_container_visibility.bind(this),this.set_volume_readonly=this.set_volume_readonly.bind(this),this.calculate_volume=this.calculate_volume.bind(this),this.get_float_value=this.get_float_value.bind(this),this.round=this.round.bind(this),this.set_visible=this.set_visible.bind(this),this.fetch=this.fetch.bind(this),this.ajax_submit=this.ajax_submit.bind(this),this.get_portal_url=this.get_portal_url.bind(this),this.debug=this.debug.bind(this),this.get_add_controller=this.get_add_controller.bind(this),this.is_required()){if(this.debug("load"),this.sample_type_selector="div.uidreferencefield textarea[name^='SampleType']",this.template_selector="input[id^='Template']",this.bottle_weights_selector="input[id^='Bottles-'][id*='-Weight-']",this.bottle_containers_selector="input[id^='Bottles-'][id*='-Container-']",this.bind_event_handler(),r.call(document.body.classList,"template-ar_add")>=0)for(n=0,o=(l=document.querySelectorAll(this.sample_type_selector)).length;n<o;n++)i=l[n],e(i).trigger("select");else document.querySelector("div[data-fieldname='Bottles']")&&(i=document.querySelector("input[id='Volume']")).setAttribute("readonly","readonly");return this}}var i,o;return i=t,o=[{key:"is_required",value:function(){var e,t,i,n,r,o;for(o=["template-ar_add","portaltype-analysisrequest"],t=i=0,n=(r=document.body.classList).length;i<n;t=++i)if(e=r[t],o.includes(e))return!0;return!1}},{key:"bind_event_handler",value:function(){return this.debug("bind_event_handler"),e("body").on("SampleType:after_change",this.sample_type_selector,this.on_sample_type_selected),e("body").on("selected",this.template_selector,this.on_template_selected),e("body").on("blur",this.bottle_containers_selector,this.on_bottle_container_blur),e("body").on("change",this.bottle_weights_selector,this.on_bottle_weight_change)}},{key:"on_template_selected",value:function(t){var i,n,r;if(this.debug("on_template_selected"),i=t.currentTarget,n=this.get_sample_index(i),r=e("#".concat(i.id)).attr("uid"))return this.fetch(r,[]).done((function(e){var t;if(e)return t=e.SampleType_uid,this.update_container(n,t)}))}},{key:"on_bottle_weight_change",value:function(e){var t,i;return this.debug("on_bottle_weight_change"),t=e.currentTarget,i=this.get_sample_index(t),this.calculate_volume(i)}},{key:"on_bottle_container_blur",value:function(e){var t,i;return this.debug("on_bottle_container_blur"),t=e.currentTarget,i=this.get_sample_index(t),this.calculate_volume(i)}},{key:"on_sample_type_selected",value:function(e){var t,i;return this.debug("on_sample_type_selected"),t=e.currentTarget,i=this.get_sample_index(t),this.update_container(i,t.value)}},{key:"get_sample_index",value:function(t){var i;return this.debug("get_sample_index:element=".concat(t.id)),(i=t.closest("td[arnum]"))?e(i).attr("arnum"):null}},{key:"update_container",value:function(e,t){var i;return this.debug("update_container:sample_index=".concat(e,",sample_type_uid=").concat(t)),t?(i="ContainerWidget",this.fetch(t,i).done((function(t){var n;if(n=!1,t&&(n="container"===t[i]),this.toggle_container_visibility(e,n),this.set_volume_readonly(e,!n),!n)return this.calculate_volume(e)}))):(this.toggle_container_visibility(e,!0),this.set_volume_readonly(e,!1))}},{key:"toggle_container_visibility",value:function(e,t){return this.debug("toggle_container_visibility:sample_index=".concat(e,",show_container=").concat(t)),this.set_visible("Container",e,t),this.set_visible("Bottles",e,!t)}},{key:"set_volume_readonly",value:function(e,t){var i,n;if(this.debug("set_volume_readonly:sample_index=".concat(e,",readonly=").concat(t)),n="#Volume",e&&(n="#Volume-".concat(e)),i=document.querySelector(n))return t?i.setAttribute("readonly","readonly"):i.removeAttribute("readonly")}},{key:"calculate_volume",value:function(t){var i,n,r,o,l,a;if(this.debug("calculate_volume:sample_index=".concat(t)),o=0,n="tr.records_row_Bottles",t&&(n="tr.records_row_Bottles-".concat(t)),i=document.querySelectorAll(n),r=this,e.each(i,(function(e,i){var n,l,a,s,c,u;return u="#Bottles-Weight-".concat(e),t&&(u="#Bottles-".concat(t,"-Weight-").concat(e)),c=i.querySelector(u),c=r.get_float_value(c),r.debug("Not a valid volume: ".concat(c)),l="#Bottles-DryWeight-".concat(e),t&&(l="#Bottles-".concat(t,"-DryWeight-").concat(e)),n=i.querySelector(l),n=r.get_float_value(n),r.debug("Not a valid volume: ".concat(n)),(a=c-n)<=0?(r.debug("Not a valid bottle volume: ".concat(a)),a=""):(a=r.round(1.05*a,3),o+=a),s="#Bottles-Volume-".concat(e),t&&(s="#Bottles-".concat(t,"-Volume-").concat(e)),i.querySelector(s).value=a})),o=parseFloat(o),(o=this.round(o,4))<=0?(this.debug("Not a valid volume: ".concat(o)),o=""):o+=" ml",a="#Volume",t&&(a="#Volume-".concat(t)),l=document.querySelector(a))return l.value=o}},{key:"get_float_value",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t=parseFloat(e.value),isNaN(t)&&(t=parseFloat(i)),t}},{key:"round",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return Number(Math.round(e+"e"+t)+"e-"+t)}},{key:"set_visible",value:function(t,i,n){var r,o;return this.debug("set_visible:field_name=".concat(t,",sample_index=").concat(i,",visible=").concat(n)),o="div[data-fieldname='".concat(t,"']"),i&&(o="div[data-fieldname='".concat(t,"-").concat(i,"']")),"0"===i&&"1"===document.querySelector("#ar_count").value&&(o="tr[fieldname=".concat(t,"]")),r=document.querySelector(o),n?e(r).show():e(r).hide()}},{key:"fetch",value:function(t,i){var n,r;return this.debug("fetch:uid=".concat(t,",field_names=").concat(i)),n=e.Deferred(),r={url:this.get_portal_url()+"/@@API/read",data:{catalog_name:"senaite_catalog_setup",UID:t,include_fields:i,page_size:1}},this.ajax_submit(r).done((function(e){var t;return t={},e.objects&&(t=e.objects[0]),n.resolveWith(this,[t])})),n.promise()}},{key:"ajax_submit",value:function(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.debug("ajax_submit"),null==i.type&&(i.type="POST"),null==i.url&&(i.url=this.get_portal_url()),null==i.context&&(i.context=this),null==i.dataType&&(i.dataType="json"),null==i.data&&(i.data={}),null==i._authenticator&&(i._authenticator=e("input[name='_authenticator']").val()),this.debug(">>> ajax_submit::options=",i),e(this).trigger("ajax:submit:start"),t=function(){return e(this).trigger("ajax:submit:end")},e.ajax(i).done(t)}},{key:"get_portal_url",value:function(){return e("input[name=portal_url]").val()||window.portal_url}},{key:"debug",value:function(e){}},{key:"get_add_controller",value:function(){return window.bika.lims.AnalysisRequestAdd}}],o&&n(i.prototype,o),Object.defineProperty(i,"prototype",{writable:!1}),t}();var l=i(311);function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function s(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(void 0,r=function(e,t){if("object"!==a(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,"string");if("object"!==a(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(n.key),"symbol"===a(r)?r:String(r)),n)}var r}const c=function(){function e(){var t,i,n,r;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.is_required=this.is_required.bind(this),this.on_toggle_selector_clicked=this.on_toggle_selector_clicked.bind(this),this.init_toggle=this.init_toggle.bind(this),this.init_sections_visibility=this.init_sections_visibility.bind(this),this.debug=this.debug.bind(this),this.is_required()){for(this.debug("load"),t=0,i=(r=[["#content h1","#senaite-sampleheader","palau-lims-sample-header"],["#content h1","div[id=ar-attachments]","palau-lims-sample-header"],["div.remarks-widget h3","div.remarks-widget div","palau-lims-sample-remarks-section"],["div.analysis-listing-table h3","div.analysis-listing-table form","palau-lims-sample-analyses-section"],["div[id=results-interpretation] h3","div[id=results-interpretation] form","palau-lims-sample-results-interpretation-section"]]).length;t<i;t++)n=r[t],this.init_toggle(n[0],n[1],n[2]);return l("body").on("click",".toggle_selector",this.on_toggle_selector_clicked),this.init_sections_visibility(),this}}var t,i;return t=e,(i=[{key:"is_required",value:function(){var e,t,i,n,r,o;for(o=["portaltype-analysisrequest"],t=i=0,n=(r=document.body.classList).length;i<n;t=++i)if(e=r[t],o.includes(e))return!0;return!1}},{key:"on_toggle_selector_clicked",value:function(e){var t,i,n,r,o,a;for(this.debug("on_toggle_selector_clicked"),r=e.currentTarget.getAttribute("target-section"),t=0,i=(o=document.querySelectorAll("[section=".concat(r,"]"))).length;t<i;t++)(n=o[t])&&((a=this.is_visible(n))?l(n).hide():l(n).show());return site.set_cookie(r,!a)}},{key:"init_toggle",value:function(e,t,i){var n,r;if(this.debug("init_toggle:anchor_selector='".concat(e,"',section_selector='").concat(t,"',section_id='").concat(i,"'")),(n=document.querySelector(e))&&(n.classList.add("toggle_selector"),n.setAttribute("target-section",i),r=document.querySelector(t)))return r.setAttribute("section",i)}},{key:"is_visible",value:function(e){return"none"!==l(e).css("display")}},{key:"init_sections_visibility",value:function(){var e,t,i,n,r,o,a,s;for(this.debug("set_visibility"),n=[],t=0,i=(e=document.querySelectorAll(".toggle_selector")).length;t<i;t++)o=e[t].getAttribute("target-section"),s=site.read_cookie(o)||"true",this.debug("section_id=".concat(o,", visible=").concat(s)),s="true"===s,a=document.querySelectorAll("[section=".concat(o,"]")),n.push(function(){var e,t,i;for(i=[],e=0,t=a.length;e<t;e++)r=a[e],s?i.push(l(r).show()):i.push(l(r).hide());return i}());return n}},{key:"debug",value:function(e){}}])&&s(t.prototype,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();var u=i(311);function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function _(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,(void 0,r=function(e,t){if("object"!==d(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,"string");if("object"!==d(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(n.key),"symbol"===d(r)?r:String(r)),n)}var r}const h=function(){function e(){var t,i,n,r;for(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.is_required=this.is_required.bind(this),this.bind_event_handler=this.bind_event_handler.bind(this),this.on_reference_other_selector_change=this.on_reference_other_selector_change.bind(this),this.on_reference_selected=this.on_reference_selected.bind(this),this.on_reference_deselected=this.on_reference_deselected.bind(this),this.reference_other_selector="input.reference-otherfield-check",this.reference_value_selector="div.palau-referenceother-widget-input",this.bind_event_handler(),i=0,n=(r=document.querySelectorAll(this.reference_other_selector)).length;i<n;i++)t=r[i],u(t).trigger("change");return this}var t,i;return t=e,(i=[{key:"is_required",value:function(){var e,t,i,n,r,o;for(o=["template-ar_add","portaltype-analysisrequest"],t=i=0,n=(r=document.body.classList).length;i<n;t=++i)if(e=r[t],o.includes(e))return!0;return!1}},{key:"bind_event_handler",value:function(){return u("body").on("change",this.reference_other_selector,this.on_reference_other_selector_change),u("body").on("select",this.reference_value_selector,this.on_reference_selected),u("body").on("deselect",this.reference_value_selector,this.on_reference_deselected)}},{key:"on_reference_other_selector_change",value:function(e){var t,i,n;return t=e.currentTarget,n=u(t).attr("data_target"),i=document.querySelector("#"+n),t.checked?u(i).show():(u(i).hide(),u(i).val(""))}},{key:"on_reference_selected",value:function(e){var t,i,n;return t=e.currentTarget,n="textarea#"+u(t).attr("id")+"_other",i=document.querySelector(n),u(i).hide(),u(i).val("")}},{key:"on_reference_deselected",value:function(e){var t,i,n;return t=e.currentTarget,n="textarea#"+u(t).attr("id")+"_other",i=document.querySelector(n),u(i).show()}}])&&_(t.prototype,i),Object.defineProperty(t,"prototype",{writable:!1}),e}();document.addEventListener("DOMContentLoaded",(function(){window.sampletype_container=new o,window.sampleview_layout=new c,window.reference_other=new h}))})()})();